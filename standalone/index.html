<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>WASM Test for Marching Cubes</title>
</head>
<body>
	<button id="button">Run Test (See console)</button>
	<script type="module">
		import Module from './geometry.js';

		let moduleInstance = Module;

		class Allocator {
			constructor() {
				this.offsets = [];
			}

			alloc(constructor, size) {
				if (size > 0) {
					const offset = moduleInstance._malloc(size * constructor.BYTES_PER_ELEMENT);
					const b = new constructor(moduleInstance.HEAP8.buffer, moduleInstance.HEAP8.byteOffset + offset, size);
					b.offset = offset;
					this.offsets.push(offset);
					return b;
				} else {
					return new constructor(moduleInstance.HEAP8.buffer, 0, 0);
				}
			}

			freeAll() {
				for (let i = 0; i < this.offsets.length; i++) {
					moduleInstance._doFree(this.offsets[i]);
				}
				this.offsets.length = 0;
			}
		}

		function marchingCubes(dims, potential, shift, scale) {
			let allocator = new Allocator();

			const dimsTypedArray = allocator.alloc(Int32Array, 3);
			dimsTypedArray.set(dims);

			const potentialTypedArray = allocator.alloc(Float32Array, potential.length);
			potentialTypedArray.set(potential);

			const shiftTypedArray = allocator.alloc(Float32Array, 3);
			shiftTypedArray.set(shift);

			const scaleTypedArray = allocator.alloc(Float32Array, 3);
			scaleTypedArray.set(scale);

			const outputBuffer = moduleInstance._doMarchingCubes(
				dimsTypedArray.byteOffset,
				potentialTypedArray.byteOffset,
				shiftTypedArray.byteOffset,
				shiftTypedArray.byteOffset
			);

			allocator.freeAll();

			const head = outputBuffer / 4;

			const positionCount = moduleInstance.HEAP32.subarray(head, head + 1)[0];
			const faceCount = moduleInstance.HEAP32.subarray(head + 1, head + 2)[0];
			const positions = moduleInstance.HEAPF32.subarray(head + 2, head + 2 + positionCount);
			const faces = moduleInstance.HEAP32.subarray(head + 2 + positionCount, head + 2 + positionCount +faceCount);

			return {
				positionCount: positionCount,
				faceCount: faceCount,
				positions: positions,
				faces: faces
			}
		}

		document.getElementById('button').addEventListener('click', () => {
			// var result = Module.ccall('doMarchingingCubes', null, null, null);
			const dims = [2, 2, 2];
			const potential = [1.0, -1.0, 1.0, -1.0, 1.0, -1.0, 1.0, -1.0];
			const shift = [1.0, 1.0, 1.0];
			const scale = [1.0, 1.0, 1.0];

			const output = marchingCubes(dims, potential, shift, scale);

			console.log(">>> position count: ", output.positionCount);
			console.log(">>> face count: ", output.faceCount);
			console.log(">>> positions: ", output.positions);
			console.log(">>> faces: ", output.faces);
		});


	</script>
</body>
</html>
